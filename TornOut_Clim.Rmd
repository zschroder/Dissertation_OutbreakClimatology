---
title: 'Tornado outbreak climatology in the United States (1995 - 2019): Definitions,
  description, and statistical analyses'
author: "Zoe Schroder"
date: "7/20/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

Load the libraries needed for this project. 
```{r}
suppressMessages(library(sf))
suppressMessages(library(dplyr))
#install.packages("lubridate")
suppressMessages(library(lubridate))
suppressMessages(library(USAboundaries))
#devtools::install_github("ropensci/USAboundariesData")
suppressMessages(library(USAboundariesData))
suppressMessages(library(tmap))
suppressMessages(library(ggplot2))
```

```{r}
merc =  "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
```


## Tornado-Level Statistics: 

The newest GIS shapefile contains missing geometries for more than 30% of the tornadoes. The number of missing geometries is highest after 1995. Instead here we use the csv file from https://www.spc.noaa.gov/wcm/#data  Use the start lon/lat and create a `sp` object then convert to `sf`. Set the coordinate reference system (crs) to ESPG 4326.
```{r}
Torn.spdf <- read.csv(file = "1950-2018_actual_tornadoes.csv")
sp::coordinates(Torn.spdf) <- ~ slon + slat
Torn.sfdf <- st_as_sf(Torn.spdf)

st_crs(Torn.sfdf) <- 4326
```

Remove tornadoes in Hawaii, Alaska, and Puerto Rico and those occurring before 1994. That year marks the beginning of comprehensive WSR-88D radar. For missing EF ratings use the modification rules (if/else) defined here: https://www.spc.noaa.gov/wcm/OneTor_F-scale-modifications.pdf 
```{r}
All_Tornadoes <- Torn.sfdf %>%
  filter(yr >= 1994,
         !st %in% c("AK", "PR", "HI")) %>%
  mutate(mag = ifelse(mag == -9 & len <= 5, 0, mag),
         mag = ifelse(mag == -9 & len > 5, 1, mag))
```

Add a data/time column also add columns for path length, width, and area in metric units. Leave the time zone as native CDT. Create a convective day (6AM to 6AM) column taking hours 00:00:00 -> 05:59:59 and assigning it to the previous date (this associates the previous day's date to tornadoes occurring up to 6 hours after local midnight).
```{r}
All_Tornadoes <- All_Tornadoes %>%
  mutate(#dy = format(as.Date(date,format="%y/%m/%d"), "%d"), #This is now an included column in data
         DateTime = as.POSIXct(paste(yr, mo, dy, time), format = "%Y%m%d%H:%M:%S"),
         Hour = hour(DateTime),
         Year = year(DateTime),
         cDateTime = DateTime - as.difftime(6, unit = "hours"),
         cDate = as.Date(as_datetime(ifelse(Hour < 6, (DateTime - 86400), cDateTime), tz = Sys.timezone())),
         Length = len * 1609.34,
         Length = ifelse(Length == 0, min(Length[Length > 0]), Length), #takes care of zero length
         Width = wid * .9144,
         Width = ifelse(Width == 0, min(Width[Width > 0]), Width), #takes care of zero width
         Width = ifelse(Year >= 1995, Width * pi/4, Width), #takes care of change: avg to max
         cas = inj + fat,
         AreaPath = Length * Width,
         Ma = factor(month.abb[mo], levels = month.abb[1:12])) %>%
  sf::st_sf()
dim(All_Tornadoes)[1]
```

The geometry type is `POINT`. Each tornado is represented as a single point location geometry (start location). Add power dissipation per tornado.

Add power dissipation per tornado. Use the empirical model for tornado winds by EF rating taken from Table 3-1 of NRC 2007. Percent area by EF rating for each EF category. Threshold wind speeds (m/s) are a lower bound 3-sec gusts on the operational EF Scale (Table 2-1 of NRC2007). This is based on work by Fricker et al. (2017). The model is
$$
E = A_p \rho \sum_{j=0}^{J} w_j v_j^{3},
$$
where $A_p$ is the area of the path, $\rho$ is area density [1 kg/m^3]  $v_j$ is the midpoint wind speed for each rating, and $w_j$ is the corresponding fraction of path area by EF rating. With no upper bound on the EF5 wind speeds, the midpoint wind speed is set at 97 m~s$^{-1}$ (7.5 m~s$^{-1}$ above the threshold wind speed consistent with the EF4 midpoint speed relative to its threshold)
```{r}
perc <- c(1, 0, 0, 0, 0, 0, 
          .772, .228, 0, 0, 0, 0,
          .616, .268, .115, 0, 0, 0,
          .529, .271, .133, .067, 0, 0,
          .543, .238, .131, .056, .032, 0,
          .538, .223, .119, .07, .033, .017)
percM <- matrix(perc, ncol = 6, byrow = TRUE)
threshW <- c(29.06, 38.45, 49.62, 60.8, 74.21, 89.41)
midptW <- c(diff(threshW)/2 + threshW[-length(threshW)], threshW[length(threshW)] + 7.5)
ef <- All_Tornadoes$mag + 1
EW3 <- numeric()
for(i in 1:length(ef)) EW3[i] = midptW^3 %*% percM[ef[i], ]
All_Tornadoes <- All_Tornadoes %>%
  mutate(ED = EW3 * AreaPath)
``` 

Determine the distance between tornadoes in space and time. Use a projection, not lat/lon. See https://epsg.io/102004. Extract the coordinates of the start locations as a N by 2 matrix, where N is the number of tornadoes. Also extract the date-time as a vector of class `POSIXct`.
```{r}
# Lambert Conic Conformal
All_Tornadoes <- st_transform(All_Tornadoes, crs = "+proj=lcc +lat_1=33 +lat_2=45 +lat_0=39 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m no_defs")
space <- st_coordinates(All_Tornadoes)
time <- All_Tornadoes$DateTime
```

Next compute pairwise Euclidean distances in space and, separately, in time using the `dist()` function. Divide the spatial distance by 15 so that the values are commensurate with the time 'distance' based on the assumption of 15 meters per second (~34 mph) for an average speed of tornado-generating storms. Compare: Distance from New York to Denver is 2.622 x 10^6 meters. There are 3.154 x 10^7 seconds in a year. This will capture the historic multiday tornado outbreaks. For analysis we want to consider each day in the multiday group separately. As the value of the divisor increases cluster areas get larger. Remove `ds` and `dt` to free memory. Distances are saved as an object of class `dist` containing a vector of length N * (N-1)/2, which is the number of unique point pairs.
```{r}
ds <- dist(space) / 15
dt <- dist(time)
dst <- ds + dt
rm(ds, dt)
```

Distances are saved as an object of class `dist` containing a vector of length N * (N-1)/2, which is the number of unique point pairs.

Next group the tornadoes based on the space-time distances. This is done with the `hclust()` (hierarchical cluster) function. Initially, each tornado is assigned to its own group and then the algorithm joins the two closest tornadoes determined by values in `dst`. The algorithm continues by joining tornadoes (and tornado groups) until there is a single large group.

The single linkage method (`method = "single"`) is related to the minimal spanning tree (MST) and adopts a 'friends of friends' grouping strategy. An edge-weighted graph is a graph where each edge has a weight (or cost). Here weights are space-time distances between tornadoes. A MST of an edge-weighted graph is a spanning tree whose weight (the sum of the weights of its edges) is no larger than the weight of any other spanning tree. A spanning tree of a graph on N vertices (tornado centroids) is a subset of N-1 edges that form a tree (Skiena 1990, p. 227).
 
The `cutree()` function is used to extract a group number for each tornado. Tornadoes in each group are close in space & time. Here the tree is cut at a height of 50000 space-time units. Making `h` smaller results in smaller groups (fewer tornadoes per group).
```{r}
stime <- proc.time()
tree <- hclust(dst, method = "single")
groupNumber <- as.integer(cutree(tree, h = 50000))
proc.time() - stime
```

Add the group number to each tornado. 
```{r}
All_Tornadoes$groupNumber <- groupNumber
```

# Tornado Counts

`Generate the state and county borders`. Use the laea projection. 
```{r}
sts <- state.name[!state.name %in% c("Alaska", "Hawaii")]
stateBorders <- us_states(states = sts)
counties.sf <- us_counties()

tm_shape(Torn.sfdf) +
  tm_dots() + 
tm_shape(stateBorders, projection = "+proj=lcc +lon_0=-90 +lat_1=33 +lat_2=45", is.master = TRUE) + 
  tm_borders()

#+proj=laea +lat_0=0 +lon_0=-90
#+proj=lcc +lon_0=-90 +lat_1=33 +lat_2=45
#upside down triangles and colored by EF rating
```

State tornado counts from 1994 to 2018. 

```{r}
states.sf <- st_transform(stateBorders,  
                            crs = st_crs(All_Tornadoes))
gI <- st_intersects(All_Tornadoes, states.sf, sparse = FALSE)
colnames(gI) <- states.sf$name
states.sf$GroupDayCount <- colSums(gI)
```

Remove Alaska, Hawaii, and Puerto Rico from the `states.sf` data frame.
```{r}
states.sf <- states.sf %>% 
  filter(!stusps %in% c("AK", "PR", "HI"))
```

Create a map of the outbreak density in each county in the United States. Fill by the `GroupDayCount` column. 
```{r}
states.sf <- st_transform(states.sf, 
                            crs = st_crs(stateBorders))
All_Tornadoes <- st_transform(All_Tornadoes, 
                            crs = st_crs(stateBorders))
```


```{r}
Torn.sf <- as.data.frame(Torn.spdf)

Torn.sf <- Torn.sf %>%
  filter(yr >= 1994, 
         !st %in% c("AK", "PR", "HI"))%>%
  mutate(cas = fat + inj,
         positive_slon = slon * -1, 
         lat = slat,
         long = slon)

#devtools::install_github('oswaldosantos/ggsn')
library(ggsn)
library(ggspatial)


g <- ggplot(Torn.sf, aes(x = slon, y = slat)) +
  geom_hex(bins = 50) +
  scale_fill_continuous(type = "viridis", name = "Counts") +
  borders("state", region = c(stateBorders$state_name), col = "gray70") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5), labels = c("130", "120", "110", "100", "90", "80", "70", "60")) +
    scale_y_continuous(breaks = scales::pretty_breaks(n = 6)) +
  theme_bw() +
  xlab(expression(paste('Longitude (',~degree,'W)',sep=''))) +
  ylab(expression(paste('Latitude (',~degree,'N)',sep=''))) 

g + annotation_north_arrow(which_north = "grid",   
                           height = unit(1.5, "cm"),
                          width = unit(1, "cm"),
                          pad_x = unit(2, "cm"),
                          pad_y = unit(2, "cm"),
                          style = north_arrow_orienteering()) +      
    scalebar(Torn.sf, dist = 500, 
             dist_unit = "km",
             transform = TRUE, 
             model = "WGS84", 
            location = c("bottomleft"))+  
    theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16, face="bold"), 
        legend.position = c(0.9, 0.2),
        legend.text = element_text(size=12),
        legend.title = element_text(size=12))


```

# Monthly and Yearly Variation

*Year*
```{r}
TornsbyYear <- All_Tornadoes %>% 
  group_by(year = yr) %>%
  summarize(totaltornadoes = n())
```

`Get the week labels for the data`
```{r}
x.Date <- as.Date(paste(rep(1994:2018, each = 12), rep(1:12, 2), 1, sep = "-"))
library(zoo)
x <- zoo(rnorm(24), x.Date)
times <- time(x)
ticks <- as.data.frame(x = seq(times[1], times[length(times)], by = "weeks"))

week <- as.data.frame(ticks[1:53,])
  
months <- as.data.frame(format(week, "%b"))
Mo <- as.data.frame(format(week, "%m"))
day <- as.data.frame(format(week, "%d"))

dat <- as.data.frame(cbind(week, Mo, months, day))
colnames(dat) <- c("Week", "Mo", "Month", "Day") 

dat <- dat %>%
  group_by(Month, Day, Mo) %>%
  summarize(count = n(),
            Week = paste0(Month, " ", Day))

dat <- dat[order(dat$Mo),]
```

Make a figure of the change in tornadoes per annum. 

```{r}
yeargraph <- ggplot(TornsbyYear, (aes(x = year, y = totaltornadoes))) +
  geom_smooth(method = lm, span = .5, se = FALSE, color = "gray70", size = 1) +
  geom_line(color = "black", lwd = 1) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2018,1))) +
  scale_y_continuous(limits = c(800, 2000), breaks = c(seq(800,2000,150))) + 
#  geom_smooth(aes(x = week, y = probs/100), span = .5, se = FALSE, color = "gray70", size = 1) +
  theme_bw() +
  xlab("Year") +
  ylab("Number of Tornadoes\n ")

yeargraph <- yeargraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))

yeargraph
```

*Month*
```{r}
TornsByMonth <- All_Tornadoes %>% 
  group_by(mo) %>%
  summarize(totaltornadoes = n()) 
```

`Make a figure of the total tornadoes from 1994 to 2018 by month`
```{r}
ggplot(TornsByMonth, aes(x = as.factor(mo), y = totaltornadoes)) +
  geom_bar(stat = "identity", fill = "gray70") +
  scale_x_discrete(labels = month.name) +
  scale_y_continuous(limits = c(0, NA)) +
  ylab("Number of Tornado Groups\nWith At Least 10 Tornadoes") + xlab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

( p0 <- ggplot(TornsByMonth, aes(x = mo, y = totaltornadoes)) +
  geom_bar(stat = "identity", fill = "gray70") +
  scale_x_continuous(breaks = seq(1, 12, 1), labels = month.abb) +
  scale_y_continuous(limits = c(0, 7000)) +
  coord_polar(start = 0) +
  labs(x = "Month", y = "Number of Tornadoes") +
  theme_minimal() )
```

## Daily (hourly) variation in tornado activity

```{r}
TornsbyHour <- All_Tornadoes %>% 
  group_by(TornHour = Hour) %>%
  summarize(totaltornadoes = n())
```

`Make the labels for the x-axis`
```{r}
hourlabs = c("12 AM", "1 AM", "2 AM", "3 AM", "4 AM", "5 AM", "6 AM", "7 AM", "8 AM", "9 AM", "10 AM", "11 AM", "12 PM", "1 PM","2 PM", "3 PM", "4 PM", "5 PM", "6 PM", "7 PM", "8 PM", "9 PM", "10 PM", "11 PM")

hourgraph <- ggplot(TornsbyHour, (aes(x = TornHour, y = totaltornadoes))) +
  #geom_smooth(aes(x = Tornhour, y = totaltornadoes), span = .5, se = FALSE, color = "gray70", size = 1) +
  geom_bar(stat = "identity", color = "gray70", fill = "gray70") +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(0,23,1)), labels = hourlabs) +
  scale_y_continuous(limits = c(0, 4000), breaks = c(seq(0,4000,500))) + 
#  geom_smooth(aes(x = week, y = probs/100), span = .5, se = FALSE, color = "gray70", size = 1) +
  theme_bw() +
  xlab("Hour") +
  ylab("Number of Tornadoes\n ")

hourgraph <- hourgraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))

hourgraph
```

`Make a circular bar graph`
```{r}
ggplot(TornsbyHour, (aes(x = TornHour, y = totaltornadoes))) +
  geom_bar(stat = "identity", fill = "gray70") +
  scale_x_continuous(breaks = seq(0, 23, 1), labels = hourlabs) +
  scale_y_continuous(limits = c(0, 4000)) +
  coord_polar(start = 0) +
  labs(x = "Hour", y = "Number of Tornadoes") +
  theme_minimal() 
```

##Casualties

```{r}
Torn <- All_Tornadoes %>%
  filter(yr >= 1994)
```
In 2018, there were 1126 tornadoes. 

```{r}
sum(Torn$fat, Torn$inj)
#27873 casualties
```


Compute group-level statistics. Keep only tornado groups with at least 30 tornadoes.
```{r}
Groups.sfdfT <- All_Tornadoes %>%
  group_by(groupNumber) %>%
  summarize(Year = first(Year),
            Month = first(mo),
            FirstDate = first(date),
            LastDate = last(date),
            Name = paste(FirstDate, "to", LastDate),
            FirstcDate = first(cDate),
            LastcDate = last(cDate),
            ncD = n_distinct(cDate),
            nT = n(),
            n0 = sum(mag == 0),
            n1 = sum(mag == 1),
            n2 = sum(mag == 2),
            n3 = sum(mag == 3),
            n4 = sum(mag == 4),
            n5 = sum(mag == 5),
            ATP = sum(ED),
            ATP_TW = paste(round(ATP/10^12), "TW"),
            maxEF = max(mag),
            nD = n_distinct(date),
            StartTime = first(DateTime),
            EndTime = last(DateTime),
            Duration = difftime(EndTime, StartTime, units = "secs"), 
            cas = sum(inj + fat)) %>%
  filter(nT >= 30)
dim(Groups.sfdfT)
```
There are 6156 Groups and 155 large groups.

Get the tornadoes that are in the 155 large groups. 
```{r}
GroupTornadoes <- All_Tornadoes %>%
  filter(groupNumber %in% Groups.sfdfT$groupNumber)
```


**Map of the longest tornado outbreak. Tornado points colored by cDate. **
```{r}
states.sf <- st_transform(states.sf, 
                            crs = st_crs(stateBorders))
Groups.sfdfT <- st_transform(Groups.sfdfT, 
                            crs = st_crs(stateBorders))
```

```{r, eval = FALSE}
longestgroup <- Groups.sfdfT %>%
  filter(groupNumber == 3075)
longestgroup <- st_convex_hull(longestgroup)

#longestdays <- BigDays.sfdfT %>%
 # filter(groupNumber == 3075)

longestdaytorns <- GroupTornadoes %>%
  filter(groupNumber == 3075)
```

```{r, eval = FALSE}
states.sf <- us_states()
counties.sf <- us_counties()

longestdaytorns <- longestdaytorns %>%
  mutate(ID = as.factor(gsub("-", "", cDate)))

longestdaytorns$ID <- factor(longestdaytorns$ID, levels = levels(longestdaytorns$ID))
```

```{r}
sts <- state.name[!state.name %in% c("Alaska", "Hawaii")]
stateBorders <- us_states(states = sts)

tm_shape(stateBorders) + 
  tm_borders(col = "gray70") +
  tm_layout(legend.bg.color = "white", legend.text.size = .75) +
#tm_shape(counties.sf) +
#  tm_borders(col = "gray40", alpha = .3) +
tm_shape(longestgroup, projection = merc, is.master = TRUE) + 
  tm_borders(col = "gray15", alpha = 1, lwd = 5) +
  tm_scale_bar(width = .3, size = 0.9, lwd = 2, color.dark = "gray70") +
  tm_compass(size = 3, lwd = 2, fontsize = 1, color.dark = "gray70") + 
    tm_format("World", legend.position = c("left", "top"),
                    attr.position = c("left", "top"),
                   legend.frame = FALSE,
                   #title = "Longest Group of Tornadoes",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
                   inner.margins = c(.05, .2, .05, .2)) + #.15S, .15W, .1,N .2 E
  tm_layout(legend.bg.color = "white", legend.text.size = .5) +
tm_shape(longestdaytorns) +
  tm_symbols(size = 4, alpha = 0.8, col = "ID", n = 5, palette = "seq", title.col = "September", labels = c("4th", "5th", "6th", "7th", "8th"), border.alpha = 0) + 
  tm_layout(legend.title.size = 1.6,
            legend.position = c("right", "bottom"), 
            legend.stack = "horizontal",
            legend.frame = FALSE, 
            legend.text.size = 1.2, legend.width = -0.2, aes.palette = list(seq = "BuPu"))
```
`Figure 1: A cluster of tornadoes in 2004 that occurred between September 4th and 8th. Each circle is a tornado genesis location colored by the day of occurrence. The black line is the minimum convex polygon surrounding all the genesis locations (convex hull)` 

```{r}

```



Compute group-level statistics. Keep only tornado groups with at least 30 tornadoes.
```{r}
BigDays.sfdfT <- All_Tornadoes %>%
  group_by(groupNumber) %>%
  summarize(Year = first(Year),
            Month = first(mo),
            FirstDate = first(date),
            LastDate = last(date),
            Name = paste(FirstDate, "to", LastDate),
            FirstcDate = first(cDate),
            LastcDate = last(cDate),
            ncD = n_distinct(cDate),
            nT = n(),
            n0 = sum(mag == 0),
            n1 = sum(mag == 1),
            n2 = sum(mag == 2),
            n3 = sum(mag == 3),
            n4 = sum(mag == 4),
            n5 = sum(mag == 5),
            ATP = sum(ED),
            ATP_TW = paste(round(ATP/10^12), "TW"),
            maxEF = max(mag),
            nD = n_distinct(date),
            StartTime = first(DateTime),
            EndTime = last(DateTime),
            Duration = difftime(EndTime, StartTime, units = "secs"), 
            cas = sum(inj + fat)) %>%
  filter(nT >= 10)
dim(Groups.sfdfT)
```

```{r}
load("BigDays.RData")
```

**Create a map showing the frequency of big tornado days by county. First transform the CRS of the county boundaries to match the CRS of `BigDays.sfdfT`.**
```{r, eval = FALSE}
counties.sf <- st_transform(counties.sf, 
                            crs = st_crs(BigDays.sfdfT))

stateBorders <- st_transform(stateBorders, 
                            crs = st_crs(BigDays.sfdfT))
```

**Extract the geographic centroids of tornado genesis on big tornado days by creating an `sf` object using `st_centroid()` that reduces the MULTIPOINT geometry to a POINT geometry. Compute the area of the group and the number of tornadoes per area (density).**
```{r}
groupDayCentroids.sfdfT <- st_centroid(BigDays.sfdfT)
groupDayCentroids.sfdfT$groupArea <- st_area(st_convex_hull(BigDays.sfdfT))
groupDayCentroids.sfdfT$groupDensity <- groupDayCentroids.sfdfT$nT/groupDayCentroids.sfdfT$groupArea
```

```{r}
All_Tornadoes <- All_Tornadoes %>%
  mutate(ID = as.factor(gsub("-", "", cDate)), groupNumber)
```


```{r}
#Extract the big day using the unique ID created. 
cluster4 <- BigDays.sfdfT %>%
  filter(ID == 19951111585)
cluster3 <- BigDays.sfdfT %>%
  filter(ID == 19951111586)

#Generate a convex hull around the big day. 
cluster4 <- st_convex_hull(cluster4)
cluster3 <- st_convex_hull(cluster3)

#Extract all tornadoes that are in the biggestday 
cluster4torns <- All_Tornadoes %>%
  filter(ID == 19951111 & groupNumber == 585) 
cluster3torns <- All_Tornadoes %>%
  filter(ID == 19951111 & groupNumber == 586) 

clustorns <- All_Tornadoes %>%
  filter(ID == 19951111) 
```

```{r}
D <- tm_shape(stateBorders) + 
  tm_borders(col = "gray70") +
tm_shape(clustorns, 
         projection = merc, 
         is.master = TRUE) + 
    tm_symbols(size = 3, 
               alpha = 0, 
               border.alpha = 0) +  
tm_shape(cluster4) + 
  tm_borders(col = "gray15", 
             alpha = 1, 
             lwd = 2) + 
    tm_format("World", 
              attr.position = c("left", "top"),
              legend.frame = FALSE,
              inner.margins = c(.15, .1, .2, .1)) +
    tm_layout(legend.bg.color = "white", 
            legend.text.size = .75) + 
tm_shape(cluster4torns) +
    tm_symbols(size = 2, 
               col = "blue",
               alpha = 0.8, 
               border.alpha = 0) +
    tm_layout(legend.title.size = 1.4,
              legend.position = c("right", "bottom"), 
              legend.stack = "horizontal",
              legend.frame = FALSE, 
              legend.text.size = 1.2, 
              legend.width = -0.2, 
              title.size = 1.5) +
tm_shape(cluster3) + 
  tm_borders(col = "gray15", 
             alpha = 1, 
             lwd = 2) +
  tm_scale_bar(color.dark = "gray70", 
               width = .3, 
               size = 1, 
               lwd = 2, 
               position = c("left","bottom")) +
    tm_compass(color.dark = "gray70", 
             size = 5, 
             lwd = 2, 
             position = c("right","bottom")) + 
    tm_format("World", 
              attr.position = c("left", "top"),
              legend.frame = FALSE,
              inner.margins = c(.15, .1, .2, .1)) +
    tm_layout(legend.bg.color = "white", 
            legend.text.size = .75) + 
tm_shape(cluster3torns) +
    tm_symbols(size = 2, 
               col = "red",
               alpha = 0.8, 
               border.alpha = 0) +
    tm_layout(title = "November 11, 1995", 
              title.position = c("center", "top"), 
              legend.title.size = 3,
              legend.position = c("right", "bottom"), 
              legend.stack = "horizontal",
              legend.frame = FALSE, 
              legend.text.size = 1.2, 
              legend.width = -0.2, 
              title.size = 2)
  
D
```



```{r, eval = FALSE}
April27 <- BigDays.sfdfT %>%
  filter(cDate == "2011-04-27")
April27 <- st_convex_hull(April27)

April27centroid <- groupDayCentroids.sfdfT %>%
  filter(cDate == "2011-04-27")

April27tornadoes <- BigDayTornadoes %>% 
  filter(groupNumber == April27centroid$groupNumber)

April27tornadoes <- April27tornadoes %>%
  mutate(Hour2 = ifelse(Hour <= 6, Hour + 24, Hour))
```

*Extract the Hull, centroids, and tornadoes for the May 30, 2004 big day. *

```{r, eval = FALSE}
May30 <- BigDays.sfdfT %>%
  filter(cDate == "2004-05-30")
May30 <- st_convex_hull(May30)

May30centroid <- groupDayCentroids.sfdfT %>%
  filter(cDate == "2004-05-30")

May30tornadoes <- BigDayTornadoes %>% 
  filter(groupNumber == May30centroid$groupNumber)

May30tornadoes <- May30tornadoes %>%
  mutate(Hour2 = ifelse(Hour <= 6, Hour + 24, Hour))
```

```{r, eval = FALSE}
May6 <- BigDays.sfdfT %>%
  filter(cDate == "2003-05-06") %>%
  filter(groupNumber == "2624")
May6 <- st_convex_hull(May6)

200305062624

May6centroid <- groupDayCentroids.sfdfT %>%
  filter(cDate == "2003-05-06") %>%
  filter(groupNumber == "2624")

May6tornadoes <- BigDayTornadoes %>% 
  filter(groupNumber == May6centroid$groupNumber) %>%
  filter(cDate == "2003-05-06") 

May6tornadoes <- May6tornadoes %>%
  mutate(Hour2 = ifelse(Hour <= 6, Hour + 24, Hour))
```

**Make a map of the May 30 tornado day. Obtain the state and county boundaries from the `USAboundaries` package. **
```{r, eval = FALSE}
May30tornadoes$Hour2 <- cut(May30tornadoes$Hour2, breaks=c(6,12,18,24,30))

tm_shape(stateBorders) + 
  tm_borders(col = "gray70", alpha = 1) +
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70") +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") + 
  tm_layout(legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("right", "top"), 
            inner.margins = c(.15, .15, .1, .2)) +
#tm_shape(counties.sf) +
#  tm_borders(col = "gray40", alpha = .3) +
#  tm_scale_bar(width = 8, size = 8, color.dark = "gray70") +
  #tm_format("World", legend.position = c("right", "top"),
#                   attr.position = c("right", "top"),
#                   legend.frame = FALSE,
                   #title = "May 30th Tornado Group",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
 #                  inner.margins = c(.2, .2, .2, .2)) +
tm_shape(May30, is.master = TRUE, projection = merc) +
  tm_borders(col = "black", lwd = 3) +
tm_shape(May30tornadoes) +
  tm_symbols(size = 4, col = "Hour2", alpha = 0.8, palette = "BuPu", title.col = "Time [CST]", labels = c("6 to 12", "12 to 18", "18 to 24", "0 to 6"), border.alpha = 0) +
    tm_layout(legend.title.size = 1.1,
            legend.position = c("right", "bottom"), 
            legend.stack = "horizontal",
            legend.frame = FALSE, 
            legend.text.size = 1, legend.width = -0.2) +
tm_shape(May30centroid) +
  tm_symbols(size = 1.25, col = "black", shape = 24) 
```

**Extract the geographic centroids of tornado genesis on big tornado days by creating an `sf` object using `st_centroid()` that reduces the MULTIPOINT geometry to a POINT geometry. Compute the area of the group and the number of tornadoes per area (density).**
```{r}
groupDayCentroids.sfdfT <- st_centroid(BigDays.sfdfT)
groupDayCentroids.sfdfT$groupArea <- st_area(st_convex_hull(BigDays.sfdfT))
groupDayCentroids.sfdfT$groupDensity <- groupDayCentroids.sfdfT$nT/groupDayCentroids.sfdfT$groupArea
```

*Extract the Hull, centroids, and tornadoes for the May 30, 2004 big day. *

```{r}
May27 <- BigDays.sfdfT %>%
  filter(cDate == "1996-05-27")
May27 <- st_convex_hull(May27)

May27centroid <- groupDayCentroids.sfdfT %>%
  filter(cDate == "1996-05-27")

May27tornadoes <- BigDayTornadoes %>% 
  filter(groupNumber == May27centroid$groupNumber)

May27tornadoes <- May27tornadoes %>%
  mutate(Hour2 = ifelse(Hour <= 6, Hour + 24, Hour))
```

**Make a map of the May 30 tornado day. Obtain the state and county boundaries from the `USAboundaries` package. **
```{r}
May27tornadoes$Hour2 <- cut(May27tornadoes$Hour2, breaks=c(6,12,18,24,30))

May1996 <- (tm_shape(stateBorders) + 
  tm_borders(col = "gray70", alpha = 1) +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") + 
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70") +
  tm_layout(legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("left", "bottom"), 
            inner.margins = c(.2, .2, .2, .2)) +
#tm_shape(counties.sf) +
#  tm_borders(col = "gray40", alpha = .3) +
#  tm_scale_bar(width = 8, size = 8, color.dark = "gray70") +
  #tm_format("World", legend.position = c("right", "top"),
#                   attr.position = c("right", "top"),
#                   legend.frame = FALSE,
                   #title = "May 30th Tornado Group",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
 #                  inner.margins = c(.2, .2, .2, .2)) +
tm_shape(May27, is.master = TRUE, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
  tm_borders(col = "black", lwd = 3) +
tm_shape(May27tornadoes) +
  tm_symbols(size = 4, col = "Hour2", alpha = 0.8, palette = "BuPu", title.col = "Time [CST]", labels = c("6 to 12", "12 to 18", "18 to 24", "0 to 6"), border.alpha = 0) +
    tm_layout(legend.title.size = 1.1,
            legend.position = c("right", "bottom"), 
            legend.stack = "horizontal",
            legend.frame = FALSE, 
            legend.text.size = 1, legend.width = -0.2) +
tm_shape(May27centroid) +
  tm_symbols(size = 1.25, col = "black", shape = 24) +
  tm_layout(title = "May 27, 1996 \n 10 tornadoes", 
              title.position = c("center", "top"), 
              legend.title.size = 1.4,
              legend.position = c("right", "bottom"), 
              legend.stack = "horizontal",
              legend.frame = FALSE, 
              legend.text.size = 1.2, 
              legend.width = -0.2, 
              title.size = 1.5))
May1996
```

```{r}
May05 <- BigDays.sfdfT %>%
  filter(cDate == "2007-05-05")
May05 <- st_convex_hull(May05)

May05centroid <- groupDayCentroids.sfdfT %>%
  filter(cDate == "2007-05-05")

May05tornadoes <- BigDayTornadoes %>% 
  filter(groupNumber == May05centroid$groupNumber)

May05tornadoes <- May05tornadoes %>%
  mutate(Hour2 = ifelse(Hour <= 6, Hour + 24, Hour))
```

**Make a map of the May 30 tornado day. Obtain the state and county boundaries from the `USAboundaries` package. **
```{r}
May05tornadoes$Hour2 <- cut(May05tornadoes$Hour2, breaks=c(6,12,18,24,30))

May2007 <- (tm_shape(stateBorders) + 
  tm_borders(col = "gray70", alpha = 1) +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") +       
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70") +
  tm_layout(legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("left", "bottom"), 
            inner.margins = c(.15, .15, .15, .15)) +
#tm_shape(counties.sf) +
#  tm_borders(col = "gray40", alpha = .3) +
#  tm_scale_bar(width = 8, size = 8, color.dark = "gray70") +
  #tm_format("World", legend.position = c("right", "top"),
#                   attr.position = c("right", "top"),
#                   legend.frame = FALSE,
                   #title = "May 30th Tornado Group",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
 #                  inner.margins = c(.2, .2, .2, .2)) +
tm_shape(May05, is.master = TRUE, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
  tm_borders(col = "black", lwd = 3) +
tm_shape(May05tornadoes) +
  tm_symbols(size = 4, col = "Hour2", alpha = 0.8, palette = "BuPu", title.col = "Time [CST]", labels = c("6 to 12", "12 to 18", "18 to 24", "0 to 6"), border.alpha = 0) +
    tm_layout(legend.title.size = 1.1,
            legend.position = c("right", "bottom"), 
            legend.stack = "horizontal",
            legend.frame = FALSE, 
            legend.text.size = 1, legend.width = -0.2) +
tm_shape(May05centroid) +
  tm_symbols(size = 1.25, col = "black", shape = 24)  +
  tm_layout(title = "May 5, 2007 \n 90 tornadoes", 
              title.position = c("center", "top"), 
              legend.title.size = 1.4,
              legend.position = c("right", "bottom"), 
              legend.stack = "horizontal",
              legend.frame = FALSE, 
              legend.text.size = 1.2, 
              legend.width = -0.2, 
              title.size = 1.5)
)

May2007
```


```{r}
tmap_arrange(May1996, May2007)
```

```{r}
Apr12 <- read.csv("April122020_Outbreak.csv", header = TRUE)
```

```{r}
Apr12.sfdfT = st_as_sf(Apr12, coords = c("LON", "LAT"), 
                 crs = 4326)

library(rgeos)
testhull <- gConvexHull(as_Spatial(Apr12.sfdfT))
```

```{r}
Southeast <- stateBorders %>%
  filter(stusps %in% c("TX", 'OK','AR','LA','MS','TN',"AL", 'GA','FL','SC','NC','VA','KY'))
```


```{r, eval = FALSE}
tm_shape(stateBorders) + 
  tm_borders(col = "gray70", alpha = 1) +
    tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70", , position = c("left", "bottom")) + 
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70", position = c("left", "bottom")) +
  tm_layout(title = "April 12, 2020 \n 183 tornadoes",
            legend.bg.color = "white", 
            legend.text.size = .75, 
            inner.margins = c(0.3, 0.091, 0.2, 0.091), 
            title.position = c("center", "top") )+
tm_shape(testhull, is.master = TRUE, projection = merc) +
  tm_borders(col = "black", lwd = 3) +
tm_shape(Apr12.sfdfT) +
  tm_bubbles(size = 0.75, col = "purple3", border.lwd = 0, alpha = 0.6 ) 
```





###########################################
## Plot Environment Data for May 6, 2003 ##
###########################################

```{r}
BigDays.sfdfT <- BigDays.sfdfT %>%
 mutate(ID = paste0(gsub("-", "", cDate), groupNumber))

BigDayTornadoes <- BigDayTornadoes %>%
 mutate(ID = paste0(gsub("-", "", cDate), groupNumber))
```

*May 6, 2003 Big Day*
```{r}
May6 <- BigDays.sfdfT %>%
  filter(ID == "200305062624")
May6th <- st_convex_hull(May6)

May6centroid <- groupDayCentroids.sfdfT %>%
  filter(ID == "200305062624")

May6tornadoes <- All_Tornadoes %>% 
  filter(ID == "20030506" & groupNumber == "2624")
```

```{r, eval = FALSE}
tm_shape(stateBorders) + 
  tm_borders(col = "gray70", alpha = 1) +
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70") +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") + 
  tm_layout(legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("right", "top"), 
            inner.margins = c(.15, .15, .1, .2)) +
#tm_shape(counties.sf) +
#  tm_borders(col = "gray40", alpha = .3) +
#  tm_scale_bar(width = 8, size = 8, color.dark = "gray70") +
  #tm_format("World", legend.position = c("right", "top"),
#                   attr.position = c("right", "top"),
#                   legend.frame = FALSE,
                   #title = "May 30th Tornado Group",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
 #                  inner.margins = c(.2, .2, .2, .2)) +
tm_shape(May6, is.master = TRUE, projection = merc) +
  tm_borders(col = "black", lwd = 3) +
tm_shape(May6tornadoes) +
  tm_symbols(size = 2, col = "purple4", alpha = 0.8, border.alpha = 0) +
    tm_layout(legend.title.size = 1.1,
            legend.position = c("right", "bottom"), 
            legend.stack = "horizontal",
            legend.frame = FALSE, 
            legend.text.size = 1, legend.width = -0.2) +
tm_shape(May6centroid) +
  tm_symbols(size = 1.25, col = "black", shape = 24) 
```

*Plot the CAPE, HLCY, and CIN for the May 6, 2003 Big Day. First, read in the raster. *
```{r}
library(raster)
 rb <- brick(paste0("/Users/zoeschroder/Desktop/Projects/Dissertation_OutbreakClimatology/merged_AWIP32.20030506/merged_AWIP32.2003050612")) #<-- this is for varying NARR times
  CAPE <- raster(rb, layer = 375)
  HLCY <- raster(rb, layer = 323)
  CIN <- raster(rb, layer = 376)
  UGRD500 <- raster(rb, layer = 117) 
  VGRD500 <- raster(rb, layer = 118) 
  UGRDsfc <- raster(rb, layer = 293) 
  VGRDsfc <- raster(rb, layer = 294)     
  BS <- sqrt(((UGRD500 - UGRDsfc)**2) + ((VGRD500 - VGRDsfc)**2))
```

**Convective Available Potential energy **
```{r}
CAPE_May6 <- crop(CAPE, extent(May6))
CAPE_extent<- mask(CAPE_May6, May6)
plot(CAPE_extent)

maxCAPE <- which.max(CAPE_extent) #Returns a pixel number

#Test that this max value equals the one in BigDays.sfdfT
test <- getValues(CAPE_extent) 
test<-as.matrix(test, ncol=1)
```

```{r}
CAPEmaxpos <- xyFromCell(CAPE_extent, maxCAPE)

xy <- data.frame(CAPEmaxpos)
CAPE_latlon <- data.frame(lon=xy$x, lat=xy$y)
print(CAPE_latlon)

CAPE_latlon <- SpatialPoints(CAPE_latlon)
proj4string(CAPE_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r}
counties <- us_counties()
states <- us_states()
```

```{r, eval = FALSE}
p1 <- tm_shape(CAPE_extent) +
  tm_raster(title = "",  n = 6, palette = "BuPu") +
  tm_format(title = expression(paste("CAPE [J ", kg^-1, "]")), "World", legend.position = c("right", "bottom"),
                   attr.position = c("right", "bottom"),
                   legend.frame = FALSE,
                   inner.margins = c(.15, 0, .15, .18), #bottom, left, top
                    legend.text.size = 1, legend.width = -0.28, legend.title.size=1, legend.bg.color = "white", title.size = 1.4) +
#tm_shape(counties) +
  #tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, size = 0.8, position = c("right", "top"), color.dark = "gray70") +
tm_shape(states) +
  tm_borders() +
tm_shape(May6, is.master = TRUE, projection = merc) +
  tm_borders(col = "black", lwd = 3)  +
#tm_shape(May6centroid) +
#  tm_symbols(size = 1.25, col = "black", shape = 24) +
tm_shape(CAPE_latlon) + 
  tm_symbols(size = 1.4, col = "black", shape = 22)
p1
```

**Helicity**
```{r}
HLCY_May6 <- crop(HLCY, extent(May6))
HLCY_extent<- mask(HLCY_May6, May6)
plot(HLCY_extent)

maxHLCY <- which.max(HLCY_extent)
```

```{r}
HLCYmaxpos <- xyFromCell(HLCY_extent, maxHLCY)

xy <- data.frame(HLCYmaxpos)
HLCY_latlon <- data.frame(lon=xy$x, lat=xy$y)
print(HLCY_latlon)

HLCY_latlon <- SpatialPoints(HLCY_latlon)
proj4string(HLCY_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval = FALSE}
p2 <- tm_shape(HLCY_extent) +
  tm_raster(title = "", n = 5, palette = "BuPu") + #"YlGnBu") +
  tm_format(title = expression(paste("Helicity [",m^2, s^-2, "]")), "World", legend.position = c("right", "bottom"),
                   attr.position = c("right", "bottom"),
                   legend.frame = FALSE,
                   inner.margins = c(.15, 0, .15, .15), #bottom, left, top
                    legend.text.size = 1, legend.width = -0.25, legend.title.size=1, legend.bg.color = "white", title.size = 1.4) +
#tm_shape(counties) +
#  tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, size = 0.8, position = c("right", "top"), color.dark = "gray70") +
tm_shape(states) +
  tm_borders() +
tm_shape(May6, is.master = TRUE, projection = merc) +
  tm_borders(col = "black", lwd = 3)  +
#tm_shape(May6centroid) +
#  tm_symbols(size = 1.25, col = "black", shape = 24) +
tm_shape(HLCY_latlon) + 
  tm_symbols(size = 1.4, col = "black", shape = 22)
p2
```

**Convective Inhibition **
```{r}
CIN_May6 <- crop(CIN, extent(May6))
CIN_extent<- mask(CIN_May6, May6)

minCIN <- which.min(CIN_extent)
```

```{r}
CINminpos <- xyFromCell(CIN_extent, minCIN)

xy <- data.frame(CINminpos)
CIN_latlon <- data.frame(lon=xy$x, lat=xy$y)
print(CIN_latlon)

CIN_latlon <- SpatialPoints(CIN_latlon)
proj4string(CIN_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval = FALSE}
p3 <- tm_shape(CIN_extent) +
  tm_raster(title = "", n =5, palette = "BuPu") + #"YlOrBr") +
  tm_format(title = expression(paste("CIN [J ", kg^-1, "]")), "World", legend.position = c("right", "bottom"),
                   attr.position = c("right", "bottom"),
                   legend.frame = FALSE,
                   inner.margins = c(.15, 0, .15, .15), #bottom, left, top
                    legend.text.size = 1., legend.width = -0.3, legend.title.size=1, legend.bg.color = "white", title.size = 1.4) +
#tm_shape(counties) +
#  tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, size = 0.8, position = c("right", "top"), color.dark = "gray70") +
tm_shape(states) +
  tm_borders() +
tm_shape(May6, is.master = TRUE, projection = merc) +
  tm_borders(col = "black", lwd = 3)  +
#tm_shape(May6centroid) +
#  tm_symbols(size = 1.25, col = "black", shape = 24) +
tm_shape(CIN_latlon) + 
  tm_symbols(size = 1.4, col = "black", shape = 22)
p3
```

**Bulk Shear**
```{r}
BS_May6 <- crop(BS, extent(May6))
BS_extent<- mask(BS_May6, May6)
plot(BS_extent)

maxBS <- which.max(BS_extent)
```

```{r}
BSmaxpos <- xyFromCell(BS_extent, maxBS)

xy <- data.frame(BSmaxpos)
BS_latlon <- data.frame(lon=xy$x, lat=xy$y)
print(BS_latlon)

BS_latlon <- SpatialPoints(BS_latlon)
proj4string(BS_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval = FALSE}
p4 <- tm_shape(BS_extent) +
  tm_raster(title = "", n = 5, palette = "BuPu") +
  tm_format(title = expression(paste("Bulk Shear [m ", s^-1, "]")), "World", legend.position = c("right", "bottom"),
                   attr.position = c("right", "bottom"),
                   legend.frame = FALSE,
                   inner.margins = c(.15, 0, .15, .15), #bottom, left, top
                    legend.text.size = 1, legend.width = -0.2, legend.title.size=1, legend.bg.color = "white", title.size = 1.4) +
#tm_shape(counties) +
#  tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, size = 0.8, position = c("right", "top"), color.dark = "gray70") +
tm_shape(states) +
  tm_borders() +
tm_shape(May6, is.master = TRUE, projection = merc) +
  tm_borders(col = "black", lwd = 3)  +
#tm_shape(May6centroid) +
#  tm_symbols(size = 1.25, col = "black", shape = 24) +
tm_shape(BS_latlon) + 
  tm_symbols(size = 1.4, col = "black", shape = 22)
p4
```

**Combine into one figure: **
```{r}
tmap_arrange(p1, p2, p3, p4, ncol = 2, nrow = 2)
```
`Figure 4: Environmental conditions at 12 UTC on May 6, 2003. The black line is the spatial extent of the tornado genesis locations and the black triangle is the centroid of the locations. The first tornado in the cluster started at 14:20 UTC. The black square indicates the locations of the highest value of CAPE (3660~J~kg$^{-1}$), the lowest value of CIN ($-$149~J~kg$^{-1}$), the highest value of helicity (308~m$^2$~s$^{-2}$) and the highest value of bulk shear (33~m~s$^{-1}$).`



\textit{FIGURE OF A CLUSTER}

Surface Temperatures from National Oceanic and Atmospheric Association's (NOAA) Global Surface Temperature (NOAAGlobalTemp) data provided by the NOAA/OAR/ESRL PSL (\url{https://psl.noaa.gov/data/gridded/data.noaaglobaltemp.html}). NOAAGlobalTemp is a combination of land and ocean temperatures combined into a singular dataset. The data includes monthly surface temperatures (both land and water) from 1880 to present. It has a spatial resolution of 5$^\circ$ by 5$^\circ$. 

```{r}
library(raster)
ncpath <- "~/Desktop/Projects/Dissertation_OutbreakClimatology/"
ncname <- "air.mon.anom"  
ncfname <- paste(ncpath, ncname, ".nc", sep="")

tmp_raster <- brick(ncfname, varname="air")
class(tmp_raster)


Month1994to2020 <- seq(1369,1688, 1)

January1994 <- subset(tmp_raster, 1369)
as.data.frame(January1994) #-- > must cut it to the extent of the US

September2020 <- subset(tmp_raster, 1688)
```

```{r, eval = FALSE}
for(i in Month1994to2020){
  print(i)
  #if year = 1994 and month = 1 then you want subset(tmp_raster, 1369)
  CAPE <- raster(rb, layer = 375)
}
```

Sea Surface Temperatures: 

YOu need to switch this to the western Caribbeann. Check ElsnerWiden2014
```{r}
#download.file(url = "https://www.cpc.ncep.noaa.gov/data/indices/sstoi.atl.indices",
#              destfile = "ATL_SST.csv", mode = "wb")  
              #https://psl.noaa.gov/cgi-bin/data/timeseries/timeseries.pl?ntype=1&var=SST&level=2000&lat1=30&lat2=60&lon1=300&lon2=340&iseas=0&mon1=0&mon2=0&iarea=0&typeout=1&Submit=Create+Timeseries
download.file(url = "https://psl.noaa.gov/cgi-bin/data/timeseries/timeseries.pl?ntype=1&var=SST&level=2000&lat1=5&lat2=20&lon1=300&lon2=330+&iseas=0&mon1=0&mon2=0&iarea=0&typeout=1&Submit=Create+Timeseries" ,
              destfile = "Atlantic_SST.csv", mode = "wb") 
```


Nino 3.4 
https://psl.noaa.gov/data/correlation/nina34.data

#Teleconnection Indices 
```{r}
download.file(url = "ftp://ftp.cpc.ncep.noaa.gov/wd52dg/data/indices/tele_index.nh",
              destfile = "tele.csv", mode = "wb")


download.file(url = "https://psl.noaa.gov/gcos_wgsp/Timeseries/Data/nino34.long.data",
              destfile = "Nino3_4.csv", mode = "wb")
```

Arctic sea ice
```{r, eval = FALSE}
#https://nsidc.org/data/NSIDC-0051/versions/1
```


```{r}
timeseries_env <- BigDays.sfdfT %>%
  group_by(Year) %>%
  summarize(yravgCAPE = mean(maxCAPE),
            yravgCIN = mean(minCIN),
            yravgDLBS = mean(maxBS_deep),
            yravgSLBS = mean(maxBS_shallow))

anom_CAPE = mean(timeseries_env$yravgCAPE)
anom_CIN = mean(timeseries_env$yravgCIN)
anom_DLBS = mean(timeseries_env$yravgDLBS)
anom_SLBS = mean(timeseries_env$yravgSLBS)

timeseries_env <- timeseries_env %>%
  mutate(anomCAPE = yravgCAPE - anom_CAPE,
         anomCIN = yravgCIN - anom_CIN,
         anomDLBS = yravgDLBS - anom_DLBS,
         anomSLBS = yravgSLBS - anom_SLBS,
         posCAPE = anomCAPE >= 0,
         posCIN = anomCIN >= 0,
         posDLBS = anomDLBS >= 0,
         posSLBS = anomSLBS >= 0)
```


```{r, eval = FALSE}
yearCAPEgraph <- ggplot(timeseries_env, (aes(x = Year, y = yravgCAPE))) +
 geom_smooth(method = lm, span = .5, se = FALSE, color = "gray70", size = 1) +
  geom_line(color = "black", lwd = 1) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2018,1))) +
  scale_y_continuous(limits = c(1500, 3000), breaks = c(seq(1500,3000,250))) + 
#  geom_smooth(aes(x = week, y = probs/100), span = .5, se = FALSE, color = "gray70", size = 1) +
  theme_bw() +
  xlab("Year") +
  ylab("Monthly Average of Extreme CAPE (in Clusters)")

yearCAPEgraph <- yearCAPEgraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))

yearCAPEgraph
```

```{r, eval = FALSE}
yearCINgraph <- ggplot(timeseries_env, (aes(x = Year, y = yravgCIN))) +
 geom_smooth(method = lm, span = .5, se = FALSE, color = "gray70", size = 1) +
  geom_line(color = "black", lwd = 1) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2018,1))) +
  scale_y_continuous(limits = c(-175, -50), breaks = c(seq(-175,-50,25))) + 
#  geom_smooth(aes(x = week, y = probs/100), span = .5, se = FALSE, color = "gray70", size = 1) +
  theme_bw() +
  xlab("Year") +
  ylab("Monthly Average of Extreme CIN (in Clusters)")

yearCINgraph <- yearCINgraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))

yearCINgraph
```


```{r, eval = FALSE}
yearDLBSgraph <- ggplot(timeseries_env, (aes(x = Year, y = yravgDLBS))) +
 geom_smooth(method = lm, span = .5, se = FALSE, color = "gray70", size = 1) +
  geom_line(color = "black", lwd = 1) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2018,1))) +
  scale_y_continuous(limits = c(22, 34), breaks = c(seq(22,34,2))) + 
#  geom_smooth(aes(x = week, y = probs/100), span = .5, se = FALSE, color = "gray70", size = 1) +
  theme_bw() +
  xlab("Year") +
  ylab("Monthly Average of Extreme DLBS (in Clusters)")

yearDLBSgraph <- yearDLBSgraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))

yearDLBSgraph
```

```{r, eval = FALSE}
yearSLBSgraph <- ggplot(timeseries_env, (aes(x = Year, y = yravgSLBS))) +
 geom_smooth(method = lm, span = .5, se = FALSE, color = "gray70", size = 1) +
  geom_line(color = "black", lwd = 1) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2018,1))) +
  scale_y_continuous(limits = c(10, 20), breaks = c(seq(10,20,2))) + 
#  geom_smooth(aes(x = week, y = probs/100), span = .5, se = FALSE, color = "gray70", size = 1) +
  theme_bw() +
  xlab("Year") +
  ylab("Monthly Average of Extreme SLBS (in Clusters)")

yearSLBSgraph <- yearSLBSgraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))

yearSLBSgraph
```


```{r}
yearCAPEgraph <- ggplot(timeseries_env, aes(x = Year, y = anomCAPE)) +
  geom_bar(stat = "identity", aes(fill = posCAPE)) +
  scale_fill_manual(values = c("red2", "blue2"), guide = FALSE) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2018,1))) +
  geom_label(label = paste("Average:", round(anom_CAPE, digits = 2), paste0('J/kg')), x = 1998, y = -600) +
  theme_bw() +
  xlab("Year") +
  ylab("Anomalies of Extreme CAPE (in Clusters)")

yearCAPEgraph <- yearCAPEgraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))
```

```{r}
yearCINgraph <- ggplot(timeseries_env, aes(x = Year, y = anomCIN)) +
  geom_bar(stat = "identity", aes(fill = posCIN)) +
  scale_fill_manual(values = c("red2", "blue2"), guide = FALSE) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2018,1))) +
    geom_label(label = paste("Average:", round(anom_CIN, digits = 2), paste0('J/kg')), x = 1998, y = -50) +
  theme_bw() +
  xlab("Year") +
  ylab("Anomalies of Extreme CIN (in Clusters)")

yearCINgraph <- yearCINgraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))
```

```{r}

yearDLBSgraph <- ggplot(timeseries_env, aes(x = Year, y = anomDLBS)) +
  geom_bar(stat = "identity", aes(fill = posDLBS)) +
  scale_fill_manual(values = c("red2", "blue2"), guide = FALSE) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2018,1))) +
  geom_label(label = paste("Average:", round(anom_DLBS, digits = 2), paste0('m/s')), x = 1998, y = 3) +
  theme_bw() +
  xlab("Year") +
  ylab("Anomalies of Extreme DLBS (in Clusters)")

yearDLBSgraph <- yearDLBSgraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))
```

```{r}
yearSLBSgraph <- ggplot(timeseries_env, aes(x = Year, y = anomSLBS)) +
  geom_bar(stat = "identity", aes(fill = posSLBS)) +
  scale_fill_manual(values = c("red2", "blue2"), guide = FALSE) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2018,1))) +
  geom_label(label = paste("Average:", round(anom_SLBS, digits = 2), paste0('m/s')), x = 1998, y = 3.15) +
  theme_bw() +
  xlab("Year") +
  ylab("Anomalies of Extreme SLBS (in Clusters)")

yearSLBSgraph <- yearSLBSgraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))
```

```{r}
#library(ggpubr)
ggarrange(yearCAPEgraph, yearCINgraph, yearDLBSgraph, yearSLBSgraph)
```

